version: '3.9'

services:
    api:
        build: ./api
        command: ./wait-for-it.sh postgres:5432 -- ./docker-entrypoint.sh
        ports:
            - '5000:5000'
        depends_on:
            - postgres
            - redis
        restart: on-failure
        volumes:
            - ./api:/app
        environment:
            - PORT=5000
            - DATABASE_URL=postgresql://postgres:MyPassword@postgres:5432/db?schema=public
            - JWT_SECRET=asdasdasda
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - COOKIE_SECRET=sadasdasd
            - SMTP_HOST=localhost
            - SMTP_PORT=123123
            - MAILER_FROM=admin
            - FRONTEND_URL=localhost
    mailhog:
        image: mailhog/mailhog
        ports:
            - 1025:1025
            - 8025:8025
    postgres:
        image: postgres
        ports:
            - 5432:5432
        restart: always
        environment:
            - POSTGRES_DB=db
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=MyPassword
        volumes:
            - pg-data:/var/lib/postgresql/data
    redis:
        image: redis
        command: redis-server
        ports:
            - 6379:6379
        volumes:
            - redis-data:/data
            - redis-conf:/usr/local/etc/redis/redis.conf

volumes:
    pg-data:
    redis-data:
    redis-conf:
